# ============================================================================
# LICITA PRECOS - FULL SQUAD BLUEPRINT
# ============================================================================
# Designed by: Craft (Squad Creator Agent)
# Date: 2026-02-03
# Version: 1.0
# Purpose: Continue development of price research system for public procurement
# ============================================================================

metadata:
  name: licita-precos-squad
  version: "1.0.0"
  description: |
    Squad completo para desenvolvimento do sistema Licita Precos -
    ferramenta de pesquisa de precos para licitacoes publicas brasileiras
  domain: gov-tech
  language: pt-BR
  license: MIT

# ============================================================================
# GAP ANALYSIS - PNCP ENDPOINTS
# ============================================================================
# Current State: Only compras.dados.gov.br and dadosabertos.compras.gov.br
# Missing: Full PNCP API integration
# ============================================================================

data_sources:
  current:
    - name: API de Dados Abertos (Materiais/CATMAT)
      base_url: http://compras.dados.gov.br
      status: documented
      endpoints:
        - /materiais/v1/materiais
        - /servicos/v1/servicos
        - /licitacoes/v1/licitacoes
        - /fornecedores/v1/fornecedores

    - name: API de Contratos (2021+)
      base_url: https://dadosabertos.compras.gov.br
      status: documented
      endpoints:
        - /comprasContratos/v1/contratos

  missing_pncp:
    # =========================================================================
    # PNCP - PORTAL NACIONAL DE CONTRATACOES PUBLICAS
    # Base URL: https://pncp.gov.br/api/consulta/v1
    # Swagger: https://pncp.gov.br/api/consulta/swagger-ui/index.html
    # Auth: Nao requerida para consultas (API publica)
    # =========================================================================

    - name: Contratos PNCP
      endpoint: /api/consulta/v1/contratos
      method: GET
      priority: CRITICAL
      description: |
        Consulta contratos publicados no PNCP.
        Retorna valores praticados em contratacoes publicas.
      params:
        - dataInicial: Data inicial (format: YYYYMMDD)
        - dataFinal: Data final (format: YYYYMMDD)
        - codigoUnidadeGestora: Codigo UG
        - cnpjOrgao: CNPJ do orgao
        - pagina: Numero da pagina
      response_fields:
        - numeroContrato
        - valorInicial
        - valorGlobal
        - dataAssinatura
        - dataVigenciaInicio
        - dataVigenciaFim
        - objetoContrato
        - fornecedor
        - orgaoEntidade

    - name: Contratacoes PNCP
      endpoint: /api/consulta/v1/contratacoes
      method: GET
      priority: CRITICAL
      description: |
        Consulta contratacoes (licitacoes) publicadas.
        Fonte primaria de precos praticados e referencias.
      variants:
        - path: /contratacoes/publicacao
          description: Busca por data de publicacao
          params:
            - dataInicial
            - dataFinal
            - codigoModalidadeContratacao
            - pagina
        - path: /contratacoes/{cnpj}/{ano}/{sequencial}
          description: Busca contratacao especifica
      response_fields:
        - numeroCompra
        - modalidadeNome
        - valorTotalEstimado
        - valorTotalHomologado
        - situacaoCompra
        - itens (array)
        - orgaoEntidade

    - name: Atas de Registro de Preco PNCP
      endpoint: /api/consulta/v1/atas
      method: GET
      priority: HIGH
      description: |
        Atas de registro de preco - fonte excelente de precos unitarios
        ja negociados e vigentes.
      params:
        - dataInicial
        - dataFinal
        - cnpjOrgao
        - pagina
      response_fields:
        - numeroAta
        - dataAssinatura
        - dataVigenciaInicio
        - dataVigenciaFim
        - itensAta (com precos unitarios)
        - fornecedor

    - name: Itens de Contratacao PNCP
      endpoint: /api/consulta/v1/contratacoes/{cnpj}/{ano}/{seq}/itens
      method: GET
      priority: HIGH
      description: |
        Itens de cada contratacao com precos unitarios detalhados.
        Essencial para pesquisa de precos.
      response_fields:
        - numeroItem
        - descricao
        - quantidade
        - unidadeMedida
        - valorUnitarioEstimado
        - valorUnitarioHomologado
        - materialOuServico
        - codigoCatmat
        - codigoCatser

    - name: Plano de Contratacoes Anual (PCA)
      endpoint: /api/consulta/v1/pca
      method: GET
      priority: MEDIUM
      description: |
        Plano de contratacoes anuais dos orgaos.
        Util para entender demandas futuras.
      params:
        - anoPca
        - codigoClassificacaoSuperior
        - pagina

    - name: Orgaos PNCP
      endpoint: /api/consulta/v1/orgaos
      method: GET
      priority: LOW
      description: Cadastro de orgaos para enriquecimento de dados

    - name: Fornecedores PNCP
      endpoint: /api/consulta/v1/fornecedores
      method: GET
      priority: LOW
      description: Cadastro de fornecedores para enriquecimento

# ============================================================================
# AGENT ROSTER - FULL SQUAD
# ============================================================================

agents:
  # ---------------------------------------------------------------------------
  # PRODUCT & STRATEGY AGENTS
  # ---------------------------------------------------------------------------

  - id: pm
    name: Morgan
    role: Product Manager
    icon: "\U0001F4CA"
    responsibilities:
      - Gerenciar backlog e prioridades
      - Refinar requisitos com stakeholders
      - Medir sucesso (KPIs, metricas)
      - Coordenar releases
    skills:
      - product-management
      - stakeholder-communication
      - metrics-analysis
      - roadmap-planning
    assigned_artifacts:
      - docs/prd.md
      - docs/stories/

  - id: po
    name: Owen
    role: Product Owner
    icon: "\U0001F3AF"
    responsibilities:
      - Definir criterios de aceitacao
      - Validar entregas
      - Priorizar stories no sprint
      - Representar usuario final
    skills:
      - acceptance-criteria
      - user-advocacy
      - sprint-planning

  - id: analyst
    name: Ana
    role: Business Analyst
    icon: "\U0001F50D"
    responsibilities:
      - Analisar APIs externas (PNCP, compras.gov.br)
      - Mapear fluxos de dados
      - Documentar integrações
      - Identificar requisitos tecnicos
    skills:
      - api-analysis
      - data-mapping
      - requirements-documentation
      - integration-analysis
    critical_for:
      - Epic 1 Story 1.3 (Integracao API)
      - PNCP endpoints integration

  # ---------------------------------------------------------------------------
  # TECHNICAL AGENTS
  # ---------------------------------------------------------------------------

  - id: architect
    name: Aria
    role: Software Architect
    icon: "\U0001F3D7"
    responsibilities:
      - Definir arquitetura do sistema
      - Revisar decisoes tecnicas (ADRs)
      - Garantir escalabilidade
      - Aprovar design patterns
    skills:
      - system-design
      - architecture-patterns
      - technical-decisions
      - scalability-planning
    assigned_artifacts:
      - docs/architecture.md
      - src/services/ (structure)

  - id: dev
    name: Dex
    role: Full Stack Developer
    icon: "\U0001F4BB"
    responsibilities:
      - Implementar features (frontend + backend)
      - Escrever testes unitarios
      - Integrar APIs externas
      - Code review
    skills:
      - nextjs
      - typescript
      - prisma
      - react
      - api-integration
      - testing
    primary_owner: true
    tech_stack:
      - Next.js 14+ (App Router)
      - TypeScript
      - Prisma + PostgreSQL
      - shadcn/ui + Tailwind CSS
      - ExcelJS
      - lru-cache
      - Zod validation

  - id: data-engineer
    name: Dani
    role: Data Engineer
    icon: "\U0001F5C4"
    responsibilities:
      - Implementar adapters para APIs externas
      - Normalizar dados de multiplas fontes
      - Otimizar queries e cache
      - Garantir qualidade dos dados
    skills:
      - api-integration
      - data-normalization
      - caching-strategies
      - database-optimization
    critical_for:
      - ComprasGovAdapter
      - PNCPAdapter (NEW)
      - Cache strategy

  # ---------------------------------------------------------------------------
  # QUALITY & OPERATIONS AGENTS
  # ---------------------------------------------------------------------------

  - id: qa
    name: Quinn
    role: QA Engineer
    icon: "\U0001F50E"
    responsibilities:
      - Criar e executar testes
      - Validar criterios de aceitacao
      - Testar integrações
      - Relatar bugs
    skills:
      - test-planning
      - integration-testing
      - e2e-testing
      - bug-reporting
    test_stack:
      - Vitest (unit/integration)
      - Testing Library (React)
      - Playwright (E2E - phase 2)

  - id: devops
    name: Gage
    role: DevOps Engineer
    icon: "\U0001F680"
    responsibilities:
      - Configurar CI/CD (GitHub Actions)
      - Gerenciar deploy Railway
      - Monitorar health/performance
      - Configurar ambientes
    skills:
      - railway-deploy
      - github-actions
      - monitoring
      - environment-management
    infra:
      - Railway (app + PostgreSQL)
      - GitHub Actions
      - Sentry (opcional)

  - id: sm
    name: Sam
    role: Scrum Master
    icon: "\U0001F3C3"
    responsibilities:
      - Facilitar cerimonias ageis
      - Remover impedimentos
      - Medir velocidade do time
      - Garantir processo
    skills:
      - agile-facilitation
      - impediment-removal
      - velocity-tracking

  # ---------------------------------------------------------------------------
  # DESIGN AGENT
  # ---------------------------------------------------------------------------

  - id: ux-design-expert
    name: Uma
    role: UX/UI Designer
    icon: "\U0001F3A8"
    responsibilities:
      - Garantir usabilidade da interface
      - Revisar componentes UI
      - Sugerir melhorias de UX
      - Acessibilidade (WCAG AA)
    skills:
      - ui-design
      - ux-analysis
      - accessibility
      - shadcn-ui

# ============================================================================
# UPDATED SPRINT PLANNING
# ============================================================================

sprints:
  # ---------------------------------------------------------------------------
  # SPRINT 1: Foundation Completion (Stories 1.1-1.2)
  # ---------------------------------------------------------------------------
  - id: sprint-1
    name: Foundation Completion
    duration: 2 weeks
    goals:
      - Completar setup do projeto (Story 1.1)
      - Implementar fluxo de pesquisa com mock data (Story 1.2)

    stories:
      - story: "1.1"
        title: Setup do Projeto com Landing Page
        status: in_progress
        remaining_criteria:
          - AC3: Deploy no Railway (pendente)
          - AC6: README com instrucoes
        assigned: dev

      - story: "1.2"
        title: Fluxo de Pesquisa com Dados Mock
        status: not_started
        assigned: dev
        dependencies: ["1.1"]

    tasks:
      - id: T1.1
        title: Configure Railway PostgreSQL
        assignee: devops
        type: infrastructure

      - id: T1.2
        title: Create POST /api/search endpoint with mock data
        assignee: dev
        type: backend

      - id: T1.3
        title: Build ResultsTable component
        assignee: dev
        type: frontend

      - id: T1.4
        title: Add loading and error states
        assignee: dev
        type: frontend

  # ---------------------------------------------------------------------------
  # SPRINT 2: Real API Integration (Story 1.3 + PNCP)
  # ---------------------------------------------------------------------------
  - id: sprint-2
    name: Real API Integration
    duration: 2 weeks
    goals:
      - Integrar compras.dados.gov.br
      - Integrar PNCP API (NEW)
      - Implementar cache layer

    stories:
      - story: "1.3"
        title: Integracao com Fonte de Precos Real
        status: not_started
        assigned:
          - dev
          - data-engineer
        updated_criteria:
          - AC1: Integracao funcional com compras.dados.gov.br
          - AC1.1: "NEW - Integracao com PNCP /api/consulta/v1/contratos"
          - AC1.2: "NEW - Integracao com PNCP /api/consulta/v1/contratacoes"
          - AC2: Dados com descricao, preco, unidade, orgao, data
          - AC3: Tratamento de erros
          - AC4: Rate limiting
          - AC5: Cache basico (10-15 min)
          - AC6: Logs estruturados

    tasks:
      - id: T2.1
        title: Analyze PNCP API endpoints in detail
        assignee: analyst
        type: research
        output: docs/pncp-api-analysis.md

      - id: T2.2
        title: Create DataSourceAdapter interface
        assignee: architect
        type: design

      - id: T2.3
        title: Implement ComprasGovAdapter
        assignee: data-engineer
        type: backend
        path: src/services/datasource/comprasGovAdapter.ts

      - id: T2.4
        title: "NEW - Implement PNCPAdapter"
        assignee: data-engineer
        type: backend
        path: src/services/datasource/pncpAdapter.ts
        critical: true
        endpoints:
          - /api/consulta/v1/contratos
          - /api/consulta/v1/contratacoes
          - /api/consulta/v1/contratacoes/{cnpj}/{ano}/{seq}/itens

      - id: T2.5
        title: Implement CacheManager with LRU
        assignee: dev
        type: backend
        path: src/services/cache/cacheManager.ts

      - id: T2.6
        title: Create aggregated SearchService
        assignee: dev
        type: backend
        path: src/services/search/searchService.ts

      - id: T2.7
        title: Write integration tests for adapters
        assignee: qa
        type: testing

  # ---------------------------------------------------------------------------
  # SPRINT 3: Data Quality & Links (Story 1.4)
  # ---------------------------------------------------------------------------
  - id: sprint-3
    name: Data Quality & Links
    duration: 1 week
    goals:
      - Links verificaveis para cada resultado
      - Formatacao de precos e datas
      - Integracao Atas de Registro de Preco (NEW)

    stories:
      - story: "1.4"
        title: Links Verificaveis e Qualidade dos Dados
        status: not_started
        assigned: dev

    tasks:
      - id: T3.1
        title: "NEW - Add Atas de Registro de Preco adapter"
        assignee: data-engineer
        type: backend
        endpoint: /api/consulta/v1/atas

      - id: T3.2
        title: Implement URL validation service
        assignee: dev
        type: backend

      - id: T3.3
        title: Format prices (R$ X.XXX,XX) and dates (DD/MM/AAAA)
        assignee: dev
        type: frontend

      - id: T3.4
        title: Add source name display (not just URL)
        assignee: dev
        type: frontend

  # ---------------------------------------------------------------------------
  # SPRINT 4: Statistics & Filters (Stories 2.1-2.3)
  # ---------------------------------------------------------------------------
  - id: sprint-4
    name: Statistics & Filters
    duration: 2 weeks
    goals:
      - Calculo de estatisticas (media, mediana, min, max)
      - Filtros por preco, data, fonte
      - Ordenacao de resultados

    stories:
      - story: "2.1"
        title: Calculo e Exibicao de Estatisticas
        assigned: dev

      - story: "2.2"
        title: Filtros de Resultados
        assigned: dev

      - story: "2.3"
        title: Ordenacao de Resultados
        assigned: dev

    tasks:
      - id: T4.1
        title: Create StatsService with calculations
        assignee: dev
        path: src/services/stats/statsService.ts

      - id: T4.2
        title: Build StatsCard component
        assignee: dev
        path: src/components/results/StatsCard.tsx

      - id: T4.3
        title: Build FiltersPanel component
        assignee: dev
        path: src/components/results/FiltersPanel.tsx

      - id: T4.4
        title: Add sortable table headers
        assignee: dev

      - id: T4.5
        title: Add filter params to URL (shareable)
        assignee: dev

  # ---------------------------------------------------------------------------
  # SPRINT 5: Export & Pagination (Stories 2.4-2.5)
  # ---------------------------------------------------------------------------
  - id: sprint-5
    name: Export & Pagination
    duration: 2 weeks
    goals:
      - Exportacao Excel com hyperlinks
      - Paginacao de resultados

    stories:
      - story: "2.4"
        title: Exportacao para Excel
        assigned: dev

      - story: "2.5"
        title: Paginacao de Resultados
        assigned: dev

    tasks:
      - id: T5.1
        title: Implement ExcelService with ExcelJS
        assignee: dev
        path: src/services/export/excelService.ts

      - id: T5.2
        title: Create POST /api/export/excel endpoint
        assignee: dev

      - id: T5.3
        title: Build Pagination component
        assignee: dev
        path: src/components/results/Pagination.tsx

      - id: T5.4
        title: Add page size selector (10, 20, 50, 100)
        assignee: dev

  # ---------------------------------------------------------------------------
  # SPRINT 6: History & Reports (Stories 3.1-3.4)
  # ---------------------------------------------------------------------------
  - id: sprint-6
    name: History & Reports
    duration: 2 weeks
    goals:
      - Persistencia de historico
      - Interface de historico
      - Geracao de relatorio PDF

    stories:
      - story: "3.1"
        title: Persistencia do Historico de Pesquisas
        assigned: dev

      - story: "3.2"
        title: Interface de Historico de Pesquisas
        assigned: dev

      - story: "3.3"
        title: Geracao de Relatorio Oficial
        assigned: dev

      - story: "3.4"
        title: Personalizacao do Relatorio
        assigned: dev

# ============================================================================
# NEW ARCHITECTURE UPDATES
# ============================================================================

architecture_updates:
  new_services:
    - path: src/services/datasource/pncpAdapter.ts
      description: Adapter para API PNCP
      implements: DataSourceAdapter interface
      endpoints:
        - /api/consulta/v1/contratos
        - /api/consulta/v1/contratacoes
        - /api/consulta/v1/contratacoes/{cnpj}/{ano}/{seq}/itens
        - /api/consulta/v1/atas

    - path: src/services/datasource/dataSourceAggregator.ts
      description: Agregador de multiplas fontes de dados
      combines:
        - ComprasGovAdapter
        - PNCPAdapter
      features:
        - Deduplication by item code
        - Source priority ranking
        - Parallel fetching

  new_types:
    - path: src/types/pncp.ts
      description: Types para API PNCP
      interfaces:
        - PNCPContrato
        - PNCPContratacao
        - PNCPItem
        - PNCPAta
        - PNCPFornecedor
        - PNCPOrgao

  database_updates:
    - model: SearchResult
      new_fields:
        - codigoCatmat: String? # Codigo CATMAT quando disponivel
        - codigoCatser: String? # Codigo CATSER quando disponivel
        - pncpId: String? # ID unico do PNCP para rastreabilidade
        - modalidade: String? # Modalidade de contratacao

# ============================================================================
# KEY PERFORMANCE INDICATORS
# ============================================================================

kpis:
  development:
    - metric: Sprint velocity
      target: 20-25 story points/sprint
      owner: sm

    - metric: Code coverage
      target: ">= 70%"
      owner: qa

    - metric: API integration success rate
      target: ">= 95%"
      owner: data-engineer

  product:
    - metric: Search response time
      target: "< 30 seconds"
      owner: dev

    - metric: Data sources integrated
      target: "4 (compras.gov CATMAT, CATSER, contratos, PNCP)"
      owner: data-engineer

    - metric: Export success rate
      target: ">= 95%"
      owner: dev

# ============================================================================
# RISKS & MITIGATIONS
# ============================================================================

risks:
  - id: R1
    description: PNCP API rate limiting nao documentado
    probability: medium
    impact: high
    mitigation: |
      Implementar rate limiting proprio (10 req/s).
      Cache agressivo (15 min).
      Fallback para dados em cache.
    owner: data-engineer

  - id: R2
    description: Mudancas na estrutura da API PNCP
    probability: low
    impact: high
    mitigation: |
      Monitoramento de erros via Sentry.
      Abstraction layer (adapter pattern).
      Testes de integracao regulares.
    owner: architect

  - id: R3
    description: Dados duplicados entre fontes
    probability: high
    impact: medium
    mitigation: |
      Deduplication por codigo CATMAT/CATSER.
      Prioridade: PNCP > Contratos > CATMAT.
    owner: data-engineer

  - id: R4
    description: PNCP indisponivel temporariamente
    probability: medium
    impact: medium
    mitigation: |
      Circuit breaker pattern.
      Graceful degradation (usar outras fontes).
      Status indicator na UI.
    owner: dev

# ============================================================================
# SOURCES & REFERENCES
# ============================================================================

sources:
  pncp:
    - name: PNCP Portal Principal
      url: https://www.gov.br/pncp/pt-br
    - name: PNCP API Swagger
      url: https://pncp.gov.br/api/consulta/swagger-ui/index.html
    - name: Manual API PNCP
      url: https://www.gov.br/pncp/pt-br/central-de-conteudo/manuais/versoes-anteriores/ManualPNCPAPIConsultasVerso1.0.pdf
    - name: Dados Abertos PNCP
      url: https://www.gov.br/pncp/pt-br/acesso-a-informacao/dados-abertos

  compras_gov:
    - name: API Dados Abertos
      url: https://compras.dados.gov.br/docs/home.html
    - name: Swagger Contratos
      url: https://dadosabertos.compras.gov.br/swagger-ui/index.html

# ============================================================================
# APPROVAL
# ============================================================================

approval:
  status: pending
  designed_by: Craft (Squad Creator)
  designed_at: "2026-02-03T12:00:00Z"
  awaiting_approval_from:
    - Product Owner (Owen)
    - Architect (Aria)
